import torch as th
import numpy as np

import matplotlib.pyplot as plt


import torchvision.datasets as datasets
import torchvision.transforms as transforms
from torch.utils.data import DataLoader

from models.SparseConvNet import SparseConvNet

device = th.device("cuda" if th.cuda.is_available() else "cpu")

data = datasets.MNIST(root='./data', train=True, download=True, transform=transforms.ToTensor())
train_set = DataLoader(data, batch_size=128, shuffle=True)

data = datasets.MNIST(root='./data', train=False, download=True, transform=transforms.ToTensor())
test_set = DataLoader(data, batch_size=128, shuffle=False)




model = SparseConvNet().to(device)


criterion = th.nn.CrossEntropyLoss()
# optimizer = th.optim.RMSprop(model.parameters(), lr=0.0005)

optimizer = th.optim.Adam(model.parameters(),
                          lr=1e-4,
                          weight_decay=2e-4)

max_epochs = 10

train_loss, train_acc = [], []
test_loss, test_acc = [], []
epochs = list(range(max_epochs))

for e in range(max_epochs):
    print(f'>>>> Epoch {e}')
    # training
    losses, accuracies = [], []
    for x, y in train_set:
        x, y = x.to(device), y.to(device)

        # bruh mask
        # mask = (x>0).float().to(device)
        mask = (th.rand(x.shape) > 0.9).float().to(device)

        mx = model(x, mask, e, device)
        optimizer.zero_grad()
        loss = criterion(mx, y)
        loss.backward()
        optimizer.step() 
        losses.append(loss.item())
        acc = (mx.max(dim=-1)[1] == y).sum().item() / len(y)
        accuracies.append(acc)
    train_loss.append(np.mean(losses))
    train_acc.append(np.mean(acc))

    # testing
    losses, accuracies = [], []
    for x, y in test_set:
        x, y = x.to(device), y.to(device)

        # bruh mask
        mask = (x>=0).float().to(device)

        mx = model(x, mask, e, device)
        losses.append(criterion(mx, y).item())
        accuracies.append((mx.max(dim=-1)[1] == y).sum().item() / len(y))
    test_loss.append(np.mean(losses))
    test_acc.append(np.mean(accuracies))


plt.figure()
plt.plot(epochs, train_acc)
plt.plot(epochs, test_acc)
plt.legend(['Train', 'Test'])
plt.title('Accuracy')
plt.xlabel('epoch')
plt.ylabel('acc')

plt.figure()
plt.plot(epochs, train_loss)
plt.plot(epochs, test_loss)
plt.legend(['Train', 'Test'])
plt.title('Loss')
plt.xlabel('epoch')
plt.ylabel('loss')

plt.show()